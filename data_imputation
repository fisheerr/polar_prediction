"""
ä¸“é—¨ç”¨äºå¤„ç†è¾ç…§å€¼æ•°æ®ä¸­çš„ç©ºå€¼ï¼š
1. æ™šä¸Š7ç‚¹åˆ°å‡Œæ™¨4ç‚¹çš„è¾ç…§å€¼è®¾ä¸º0
2. å…¶ä»–æ—¶é—´ä½¿ç”¨KNNæ–¹æ³•è¿›è¡Œå¡«å……

"""

import pandas as pd
import numpy as np
from sklearn.impute import KNNImputer
from sklearn.preprocessing import StandardScaler
import warnings

warnings.filterwarnings('ignore')


def preprocess_solar_data_with_knn(input_file, output_file=None, target_column='å®æ³¢è¾ç…§å€¼', k=5):
    """
    ä½¿ç”¨KNNæ–¹æ³•é¢„å¤„ç†å¤ªé˜³èƒ½æ•°æ®
    
    Args:
        input_file: è¾“å…¥æ–‡ä»¶è·¯å¾„
        output_file: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
        target_column: ç›®æ ‡åˆ—å
        k: KNNçš„é‚»å±…æ•°é‡
    """
    print(f"ğŸŒ å¼€å§‹å¤„ç†æ•°æ®: {input_file}")
    print(f"ç›®æ ‡åˆ—: {target_column}")
    print(f"KNNé‚»å±…æ•°: {k}")

    # 1. åŠ è½½æ•°æ®
    print("\nğŸ“ åŠ è½½æ•°æ®...")
    df = pd.read_csv(input_file)

    # å¤„ç†æ—¥æœŸåˆ—
    if 'datestr' in df.columns:
        df['datestr'] = pd.to_datetime(df['datestr'])

    print(f"æ•°æ®å½¢çŠ¶: {df.shape}")
    print(f"æ—¥æœŸèŒƒå›´: {df['datestr'].min()} åˆ° {df['datestr'].max()}")

    # 2. åˆ†æç¼ºå¤±å€¼
    print("\nğŸ“Š åˆ†æç¼ºå¤±å€¼...")
    missing_count = df[target_column].isna().sum()
    total_count = len(df)
    missing_rate = missing_count / total_count * 100

    print(f"æ€»æ•°æ®é‡: {total_count}")
    print(f"ç¼ºå¤±å€¼æ•°é‡: {missing_count}")
    print(f"ç¼ºå¤±ç‡: {missing_rate:.2f}%")

    if missing_count == 0:
        print("âœ… æ•°æ®ä¸­æ²¡æœ‰ç¼ºå¤±å€¼ï¼Œæ— éœ€å¤„ç†")
        if output_file:
            df.to_csv(output_file, index=False)
        return df

    # 3. æå–æ—¶é—´ç‰¹å¾
    print("\nâ° æå–æ—¶é—´ç‰¹å¾...")
    df['hour'] = df['datestr'].dt.hour
    df['month'] = df['datestr'].dt.month

    # 4. å¤„ç†å¤œé—´æ—¶æ®µï¼ˆ19:00-04:59ï¼‰
    print("\nğŸŒ™ å¤„ç†å¤œé—´æ—¶æ®µ...")
    night_hours = list(range(19, 24)) + list(range(0, 5))  # 19:00-04:59
    night_mask = df['hour'].isin(night_hours)

    # å°†å¤œé—´æ—¶æ®µçš„ç¼ºå¤±å€¼è®¾ä¸º0
    night_missing_mask = night_mask & df[target_column].isna()
    df.loc[night_missing_mask, target_column] = 0
    print(f"å·²å°†å¤œé—´æ—¶æ®µç¼ºå¤±çš„ {night_missing_mask.sum()} ä¸ªå€¼è®¾ä¸º0")

    # 5. å‡†å¤‡ç‰¹å¾ç”¨äºKNN
    print("\nğŸ”§ å‡†å¤‡KNNç‰¹å¾...")

    # 6. ä½¿ç”¨KNNå¡«å……ç¼ºå¤±å€¼
    print(f"\nğŸ”§ ä½¿ç”¨KNNå¡«å……ç¼ºå¤±å€¼...")

    # åªå¤„ç†éå¤œé—´æ—¶æ®µçš„ç¼ºå¤±å€¼
    day_mask = ~df['hour'].isin(night_hours)
    missing_mask = df[target_column].isna()
    fill_mask = day_mask & missing_mask

    missing_count = fill_mask.sum()
    print(f"éœ€è¦å¡«å……çš„ç¼ºå¤±å€¼æ•°é‡: {missing_count}")

    if missing_count > 0:
        # å‡†å¤‡æ•°æ®ç”¨äºKNN
        # é€‰æ‹©æ‰€æœ‰æ•°å€¼åˆ—è¿›è¡ŒKNNå¡«å……
        numeric_columns = df.select_dtypes(include=[np.number]).columns.tolist()
        # ç§»é™¤ç›®æ ‡åˆ—ï¼Œå› ä¸ºæˆ‘ä»¬è¦å¡«å……å®ƒ
        knn_columns = [col for col in numeric_columns if col != target_column]

        print(f"KNNä½¿ç”¨çš„åˆ—æ•°: {len(knn_columns)}")

        # åˆ›å»ºKNNå¡«å……å™¨
        knn_imputer = KNNImputer(n_neighbors=k, weights='uniform')

        # å‡†å¤‡æ•°æ®
        df_knn = df[knn_columns + [target_column]].copy()

        # æ ‡å‡†åŒ–æ•°æ®ï¼ˆKNNå¯¹å°ºåº¦æ•æ„Ÿï¼‰
        scaler = StandardScaler()
        df_knn_scaled = pd.DataFrame(
            scaler.fit_transform(df_knn),
            columns=df_knn.columns,
            index=df_knn.index
        )

        # ä½¿ç”¨KNNå¡«å……
        df_knn_filled = pd.DataFrame(
            knn_imputer.fit_transform(df_knn_scaled),
            columns=df_knn.columns,
            index=df_knn.index
        )

        # åæ ‡å‡†åŒ–
        df_knn_filled_original = pd.DataFrame(
            scaler.inverse_transform(df_knn_filled),
            columns=df_knn.columns,
            index=df_knn.index
        )

        # åªæ›´æ–°ç›®æ ‡åˆ—çš„ç¼ºå¤±å€¼
        filled_values = df_knn_filled_original[target_column]
        df.loc[fill_mask, target_column] = filled_values[fill_mask]

        # ç¡®ä¿å¡«å……å€¼éè´Ÿ
        df.loc[fill_mask, target_column] = np.maximum(df.loc[fill_mask, target_column], 0)

        print(f"âœ… æˆåŠŸå¡«å…… {missing_count} ä¸ªç¼ºå¤±å€¼")

        # æ˜¾ç¤ºå¡«å……å€¼çš„ç»Ÿè®¡ä¿¡æ¯
        filled_values_stats = df.loc[fill_mask, target_column]
        print(f"å¡«å……å€¼ç»Ÿè®¡:")
        print(f"  æœ€å°å€¼: {filled_values_stats.min():.2f}")
        print(f"  æœ€å¤§å€¼: {filled_values_stats.max():.2f}")
        print(f"  å¹³å‡å€¼: {filled_values_stats.mean():.2f}")
        print(f"  æ ‡å‡†å·®: {filled_values_stats.std():.2f}")

    # 7. æ˜¾ç¤ºå¤„ç†ç»“æœæ‘˜è¦
    print("\nğŸ“Š å¤„ç†ç»“æœæ‘˜è¦:")
    print(f"  åŸå§‹æ•°æ®é‡: {total_count}")
    print(f"  åŸå§‹ç¼ºå¤±å€¼: {missing_count}")
    print(f"  å¤œé—´æ—¶æ®µæ ·æœ¬: {night_mask.sum()}")
    print(f"  å¤„ç†æˆåŠŸç‡: {((missing_count - df[target_column].isna().sum()) / missing_count * 100):.1f}%")
    # 8. ä¿å­˜ç»“æœ
    if output_file:
        df.to_csv(output_file, index=False)
        print(f"âœ… å¤„ç†åçš„æ•°æ®å·²ä¿å­˜åˆ°: {output_file}")
    return df


def main():
    input = '../data/train_data_57_914.csv'
    output = '../data/pre_train_data_57_914.csv'
    target_column = 'irradiance'
    k = 5
    try:
        # å¤„ç†æ•°æ®
        processed_df = preprocess_solar_data_with_knn(
            input,
            output,
            target_column,
            k
        )

        print("\nâœ… KNNæ•°æ®é¢„å¤„ç†å®Œæˆ!")

        # æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
        print(f"\nğŸ“ˆ æ•°æ®ç»Ÿè®¡:")
        print(f"  æ•°æ®å½¢çŠ¶: {processed_df.shape}")
        print(f"  ç›®æ ‡åˆ—ç»Ÿè®¡:")
        print(f"    æœ€å°å€¼: {processed_df[target_column].min():.2f}")
        print(f"    æœ€å¤§å€¼: {processed_df[target_column].max():.2f}")
        print(f"    å¹³å‡å€¼: {processed_df[target_column].mean():.2f}")
        print(f"    æ ‡å‡†å·®: {processed_df[target_column].std():.2f}")

    except Exception as e:
        print(f"\nâŒ KNNæ•°æ®é¢„å¤„ç†å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
