# å¤ªé˜³èƒ½é¢„æµ‹ç³»ç»Ÿ V2.0

## ğŸ‘‘ é¡¹ç›®ä»‹ç»

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº**Pyraformer**æ·±åº¦å­¦ä¹ æ¨¡å‹çš„å¤ªé˜³èƒ½è¾ç…§åº¦é¢„æµ‹ç³»ç»Ÿã€‚é€šè¿‡å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ï¼Œç»“åˆæ°”è±¡æ•°æ®å’Œå†å²è¾ç…§åº¦æ•°æ®ï¼Œå®ç°å¯¹æœªæ¥3å°æ—¶è¾ç…§åº¦çš„ç²¾å‡†é¢„æµ‹ã€‚

## ç›®å½•

- [é¡¹ç›®ä»‹ç»](#-é¡¹ç›®ä»‹ç»)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [é¡¹ç›®ç»“æ„](#-é¡¹ç›®ç»“æ„)
- [ä½¿ç”¨æŒ‡å—](#-ä½¿ç”¨æŒ‡å—)
- [æµ‹è¯•ç»“æœ](#-æµ‹è¯•ç»“æœ)
- [é…ç½®è¯´æ˜](#-é…ç½®è¯´æ˜)

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

| Module                            | Purpose                 |
|-----------------------------------|-------------------------|
| **`train_model.py`**              | Pyraformeræ¨¡å‹å¾®è°ƒå’ŒæŒ‡æ ‡è¯„ä¼°     |
| **`fine_turning/solar_model.py`** | æ¨¡å‹å¾®è°ƒæ¨¡å—ï¼Œæ”¯æŒåŸºäºé¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°å¾®è°ƒè®­ç»ƒ |
| **`data_processing/get_data.py`** | æ•°æ®è·å–æ¨¡å—ï¼Œè´Ÿè´£ä»æ•°æ®åº“è·å–æ°”è±¡å’Œè¾ç…§åº¦æ•°æ® |
| **`rolling_inference.py`**        | æ»šåŠ¨é¢„æµ‹æ¨¡å—ï¼Œæ”¯æŒè¿ç»­æ—¶é—´æ®µçš„æ»šåŠ¨é¢„æµ‹ä»»åŠ¡   | 
| **`solar_predict.py`**            | å®æ—¶é¢„æµ‹æ¨¡å—ï¼ŒåŸºäºæœ€æ–°24å°æ—¶å®æµ‹æ•°æ®è¿›è¡Œé¢„æµ‹ |

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
SolarPredictionV2.0/
â”œâ”€â”€ train_model.py                   # æ¨¡å‹å¾®è°ƒè®­ç»ƒ
â”œâ”€â”€ rolling_inference.py             # æ»šåŠ¨é¢„æµ‹æ¨¡å—
â”œâ”€â”€ solar_predict.py                 # å®æ—¶é¢„æµ‹æ¨¡å—
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.json                  # é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/                            # æ•°æ®å­˜å‚¨
â”‚   â”œâ”€â”€ train_data_57_914.csv        # è®­ç»ƒæ•°æ®
â”‚   â”œâ”€â”€ test_data_915_918.csv        # æµ‹è¯•æ•°æ®
â”‚   â””â”€â”€ pre_train_data_57_914.csv    # é¢„å¤„ç†æ•°æ®
â”œâ”€â”€ data_processing/                 # æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ data_imputation.py           # ç¼ºå¤±å€¼å¤„ç†
â”‚   â””â”€â”€ get_data.py                  # æ•°æ®è·å–
â”œâ”€â”€ fine_turning/                    # æ¨¡å‹å¾®è°ƒ
â”‚   â””â”€â”€ solar_model.py               # å¾®è°ƒæ ¸å¿ƒç±»
â”œâ”€â”€ layers/                          # æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ Conv_Blocks.py               # å·ç§¯å—
â”‚   â”œâ”€â”€ Embed.py                     # åµŒå…¥å±‚
â”‚   â”œâ”€â”€ Pyraformer_EncDec.py         # ç¼–ç å™¨-è§£ç å™¨
â”‚   â””â”€â”€ SelfAttention_Family.py      # è‡ªæ³¨æ„åŠ›æœºåˆ¶
â”œâ”€â”€ models/                          # æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ Pyraformer.py                # Pyraformeræ¨¡å‹
â”œâ”€â”€ model_pth/                       # æ¨¡å‹æƒé‡
â”‚   â”œâ”€â”€ solar_24h_3h_checkpoint.pth  # é¢„è®­ç»ƒæƒé‡
â”‚   â”œâ”€â”€ scaler_solar_24h_3h.pkl      # æ ‡å‡†åŒ–å™¨
â”‚   â””â”€â”€ finetuned_pyraformer_*.pth   # å¾®è°ƒæƒé‡
â”œâ”€â”€ utils/                           # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ timefeatures.py              # æ—¶é—´ç‰¹å¾æå–
â”‚   â”œâ”€â”€ visualize.py                 # å¯è§†åŒ–å·¥å…·
â”‚   â””â”€â”€ compute_metrics.py           # æŒ‡æ ‡è®¡ç®—
â””â”€â”€ README.md                        # é¡¹ç›®æ–‡æ¡£
```

---

## âš¡ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Python**: 3.8+

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**

```bash
git clone http://192.168.3.186/gitlab/enerrenew/ai/prediction.git
cd SolarPredictionV2.0 
python -m venv venv
source venv/bin/activate      # Windowsâ€‘PowerShell: venv\Scripts\Activate.ps1
```

2. **å®‰è£…ä¾èµ–**

```bash
pip install -r requirements.txt
```

3. **é…ç½®æ•°æ®åº“è¿æ¥**

ç¼–è¾‘ `config/config.json` æ–‡ä»¶ï¼š

```json
{
  "Mysql": {
    "host": "your_mysql_host",
    "port": 3306,
    "user": "your_username",
    "password": "your_password",
    "database": "your_database"
  },
  "Influx_config": {
    "host": "your_influx_host",
    "port": 8086,
    "user": "your_username",
    "password": "your_password",
    "database": "your_database"
  }
}
```

4. **å‡†å¤‡é¢„è®­ç»ƒæ¨¡å‹**

å°†ä»¥ä¸‹æ–‡ä»¶æ”¾ç½®åœ¨ `model_pth/` ç›®å½•ä¸‹ï¼š

- `solar_24h_3h_checkpoint.pth` - é¢„è®­ç»ƒæ¨¡å‹æƒé‡
- `scaler_solar_24h_3h.pkl` - æ•°æ®æ ‡å‡†åŒ–å™¨

5. **å¯åŠ¨ç¨‹åº**

```bash
# æ•°æ®è·å–
python data_processing/get_data.py
# KNNæ•°æ®ç¼ºå¤±å€¼å¡«å……
python data_processing/data_imputation.py

# æ¨¡å‹å¾®è°ƒè®­ç»ƒå’ŒéªŒè¯ 
python solar_predict.py

# å®æ—¶é¢„æµ‹æ¨ç†
python fine_turning/solar_predict.py

# æ»šåŠ¨é¢„æµ‹æ¨ç†
python rolling_inference.py
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ•°æ®è·å–ä¸æ ¼å¼

#### 1. åŸå§‹æ•°æ®ç¤ºä¾‹

ä»æ•°æ®åº“è·å–çš„æ°”è±¡å’Œå®æµ‹è¾ç…§åº¦æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š

```csv
datestr,temp,winddir,humidity,windspeed,pressure,precip,conditions,cloudcove,solarradiation,icon,irradiance
2025/5/7 0:00,19,110,77.61,10.8,1012,0,Overcast,100,0,cloudy,0
2025/5/7 1:00,18,120,72.75,7.2,1013,0,Partially cl,50,0,partly-cloudy-night,0
2025/5/7 2:00,17,130,68.17,5.4,1012,0,Clear,0,0,clear-night,0
2025/5/7 3:00,16,125,65.23,4.1,1013,0,Clear,0,0,clear-night,0
2025/5/7 4:00,15,115,62.45,3.8,1012,0,Clear,0,0,clear-night,0
2025/5/7 5:00,16,120,64.12,4.2,1013,0,Clear,0,0,clear-night,0
2025/5/7 6:00,18,125,66.78,5.1,1012,0,Partially cl,30,31,partly-cloudy-day,31
```

#### 2. æ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µå              | ç±»å‹  | å•ä½   | è¯´æ˜     | ç¤ºä¾‹å€¼             |
|------------------|-----|------|--------|-----------------|
| `datestr`        | å­—ç¬¦ä¸² | -    | æ—¶é—´æˆ³ï¼Œæ ¼å¼ï¼šYYYY/M/D H:MM | `2025/5/7 0:00` |
| `temp`           | æ•°å€¼  | â„ƒ    | ç¯å¢ƒæ¸©åº¦   | `19`            |
| `winddir`        | æ•°å€¼  | Â°    | é£å‘è§’åº¦ï¼ˆ0Â°ä¸ºæ­£åŒ—ï¼‰ | `110`           |
| `humidity`       | æ•°å€¼  | %    | ç›¸å¯¹æ¹¿åº¦   | `77.61`         |
| `windspeed`      | æ•°å€¼  | m/s  | é£é€Ÿ     | `10.8`          |
| `pressure`       | æ•°å€¼  | hPa  | å¤§æ°”å‹åŠ›   | `1012`          |
| `precip`         | æ•°å€¼  | mm   | é™æ°´é‡    | `0`             |
| `conditions`     | å­—ç¬¦ä¸² | -    | å¤©æ°”çŠ¶å†µæè¿° | `Overcast`      |
| `cloudcover`     | æ•°å€¼  | %    | äº‘è¦†ç›–åº¦   | `100`           |
| `solarradiation` | æ•°å€¼  | W/mÂ² | å¤ªé˜³è¾å°„å¼ºåº¦ | `0`             |
| `icon`           | å­—ç¬¦ä¸² | -    | å¤©æ°”å›¾æ ‡æ ‡è¯† | `cloudy`        |
| `irradiance`     | æ•°å€¼  | W/mÂ² | å®æ³¢å®æµ‹è¾ç…§åº¦å€¼ | `0`             |

### æ¨¡å‹å¾®è°ƒæµç¨‹

#### 2. æ¨¡å‹å¾®è°ƒå‚æ•°

| å‚æ•°         | å€¼     | è¯´æ˜       |
|------------|-------|----------|
| **è¾“å…¥åºåˆ—é•¿åº¦** | 24å°æ—¶  | å†å²æ•°æ®çª—å£   |
| **é¢„æµ‹é•¿åº¦**   | 3å°æ—¶   | æœªæ¥é¢„æµ‹çª—å£   |
| **ç‰¹å¾ç»´åº¦**   | 9ä¸ª    | æ°”è±¡ç‰¹å¾+è¾ç…§åº¦ |
| **å­¦ä¹ ç‡**    | 1e-5  | å¾®è°ƒå­¦ä¹ ç‡    |
| **æ‰¹æ¬¡å¤§å°**   | 32    | è®­ç»ƒæ‰¹æ¬¡     |
| **è®­ç»ƒè½®æ•°**   | 10-50 | å¾®è°ƒè½®æ•°     |

#### 3. å¾®è°ƒä»£ç ç¤ºä¾‹

```python
from fine_turning.solar_model import SolarModel

# åˆ›å»ºæ¨¡å‹å®ä¾‹
model = SolarModel(
    scaler_path='model_pth/scaler_solar_24h_3h.pkl',
    epochs=10,
    lr=1e-5,
    batch_size=32
)

# åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
model.load_pretrained_model('model_pth/solar_24h_3h_checkpoint.pth')

# æ‰§è¡Œå¾®è°ƒ
model.finetune_model(train_data, train_stamp, time_stamp)
```
 
---

## ğŸ§  æ¨¡å‹æ¶æ„

### Pyraformeræ¨¡å‹ç‰¹ç‚¹

| ç»„ä»¶        | é…ç½®      | è¯´æ˜              |
|-----------|---------|-----------------|
| **æ¶æ„**    | ç¼–ç å™¨-è§£ç å™¨ | åŸºäºTransformeræ¶æ„ |
| **æ³¨æ„åŠ›æœºåˆ¶** | é‡‘å­—å¡”æ³¨æ„åŠ›  | å¤šå°ºåº¦æ—¶é—´ç‰¹å¾æå–       |
| **æ—¶é—´åµŒå…¥**  | å°æ—¶çº§     | æ”¯æŒæ—¶é—´ç‰¹å¾          |
| **å¤šå¤´æ³¨æ„åŠ›** | 8å¤´ï¼Œ512ç»´ | å¹¶è¡Œæ³¨æ„åŠ›è®¡ç®—         |
| **æ®‹å·®è¿æ¥**  | æ˜¯       | é˜²æ­¢æ¢¯åº¦æ¶ˆå¤±          |

### æ¨¡å‹å‚æ•°é…ç½®
```
d_model = 512  # æ¨¡å‹ç»´åº¦
n_heads = 8  # å¤šå¤´æ³¨æ„åŠ›å¤´æ•°
dropout = 0.1  # ä¸¢å¼ƒç‡
e_layers = 2  # ç¼–ç å™¨å±‚æ•°
d_layers = 1  # è§£ç å™¨å±‚æ•°
d_ff = 2048  # å‰é¦ˆç½‘ç»œç»´åº¦
factor = 3  # æ³¨æ„åŠ›å› å­
```
---

## ğŸ“ˆ æµ‹è¯•ç»“æœ
åŸºäº9.15-9.18çš„æ•°æ®è¿›è¡Œæµ‹è¯•ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœ:
### æ¨¡å‹æ€§èƒ½å¯¹æ¯” 
åŸºäºtrain_model.pyçš„æ¨¡å‹è¯„ä¼°æµ‹è¯•ï¼Œå±•ç¤ºäº†å¾®è°ƒåæ¨¡å‹çš„æ•´ä½“æ€§èƒ½ï¼š 

| æµ‹è¯•ç±»å‹        | RÂ²    | RMSE   | MAE   | MSE      | æ•´ä½“è¯„çº§ |
|-------------|-------|--------|-------|----------|------|
| **å…¨å¤©é¢„æµ‹è¯„ä»·æŒ‡æ ‡** | 0.924 |  97.03  |52.14  |9414.00 | ä¼˜ç§€   |
| **ç™½å¤©é¢„æµ‹è¯„ä»·æŒ‡æ ‡** |0.902 | 115.24 |  80.26 | 13280.90| ä¼˜ç§€   |
 
![img.png](results/æµ‹è¯•é›†æ—¶åºå¯¹æ¯”å›¾.png)


### å®æ—¶æ¨ç†æ€§èƒ½å¯¹æ¯”
| æµ‹è¯•ç±»å‹        | RÂ²    | RMSE   | MAE   | MSE      | æ•´ä½“è¯„çº§ |
|-------------|-------|--------|-------|----------|------|
| **Pyraformer vs å®é™…å€¼** | 0.929 | 92.62 | 49.72  | 8578.44 | ä¼˜ç§€   |
| **VisualCrossing vs å®é™…å€¼** | 0.668 | 174.88 | 106.30 | 30583.66 | ä¸€èˆ¬   |


![img.png](results/å®æ—¶æ¨ç†æ€§èƒ½å¯¹æ¯”å›¾.png)

### æ»šåŠ¨æ¨ç†æ€§èƒ½å¯¹æ¯”

åŸºäºæ»šåŠ¨æ¨ç†æ¨¡å—çš„è¿ç»­é¢„æµ‹æµ‹è¯•ï¼Œå±•ç¤ºäº†æ¨¡å‹åœ¨ä¸åŒæ—¥æœŸçš„é¢„æµ‹æ€§èƒ½ï¼š

#### ç»¼åˆæ€§èƒ½å¯¹æ¯”

| æµ‹è¯•ç±»å‹        | RÂ²    | RMSE   | MAE   | MSE      | æ•´ä½“è¯„çº§ |
|-------------|-------|--------|-------|----------|------|
| **9æœˆ16æ—¥æ»šåŠ¨** | 0.925 | 116.03 | 71.61 | 13463.10 | ä¼˜ç§€   |
| **9æœˆ17æ—¥æ»šåŠ¨** | 0.931 | 109.34 | 68.17 | 11956.25 | ä¼˜ç§€   |
| **9æœˆ18æ—¥æ»šåŠ¨** | 0.377 | 198.24 | 98.64 | 39297.33 | ä¸€èˆ¬   |
| **æ»šåŠ¨å¹³å‡**    | 0.744 | 141.54 | 79.47 | 21572.23 | è‰¯å¥½   |

![img.png](results/æ»šåŠ¨æµ‹è¯•916.png)
![img.png](results/æ»šåŠ¨æµ‹è¯•917.png)
![img.png](results/æ»šåŠ¨æµ‹è¯•918.png)

### æ€§èƒ½åˆ†æ

#### âœ… ä¼˜åŠ¿

- **å¾®è°ƒåçš„æ¨¡å‹æµ‹è¯•ç»“æœ**:
    - å…¨å¤©é¢„æµ‹RÂ²è¾¾åˆ°0.924ï¼Œç™½å¤©é¢„æµ‹RÂ²è¾¾åˆ°0.902ï¼Œè¡¨ç°ä¼˜ç§€
    - å…¨å¤©MAEä»…52.14 W/mÂ²ï¼ŒRMSEä¸º97.03 W/mÂ²ï¼Œé¢„æµ‹ç²¾åº¦æé«˜
    - ç›¸æ¯”VisualCrossingï¼Œé¢„æµ‹è¯¯å·®é™ä½çº¦50% 
- **æ»šåŠ¨é¢„æµ‹**: è¿ç»­3å¤©é¢„æµ‹ä¸­ï¼Œ2å¤©è¡¨ç°ä¼˜ç§€ï¼Œ1å¤©è¡¨ç°ä¸€èˆ¬ 
- **æ—¶é—´é€‚åº”æ€§**: ç™½å¤©å’Œå…¨å¤©é¢„æµ‹å‡è¾¾åˆ°ä¼˜ç§€æ°´å¹³

#### æ”¹è¿›ç©ºé—´

- åœ¨æç«¯å¤©æ°”æ¡ä»¶ä¸‹ï¼ˆå¦‚9æœˆ18æ—¥ï¼‰ï¼Œé¢„æµ‹ç²¾åº¦ä»æœ‰æå‡ç©ºé—´ 
- é’ˆå¯¹ä¸åŒå¤©æ°”æ¨¡å¼ï¼Œå¯å¼€å‘ä¸“é—¨çš„é¢„æµ‹ç­–ç•¥
- è¿›ä¸€æ­¥ä¼˜åŒ–ç™½å¤©é¢„æµ‹ç²¾åº¦ï¼Œç¼©å°ä¸å…¨å¤©é¢„æµ‹çš„å·®è·

### æµ‹è¯•ç¯å¢ƒ

- **æ•°æ®é›†**: 2025å¹´9æœˆ15æ—¥-18æ—¥æµ‹è¯•æ•°æ®
- **é¢„æµ‹çª—å£**: 3å°æ—¶æ»šåŠ¨é¢„æµ‹ 
