# å¤ªé˜³èƒ½è¾ç…§åº¦é¢„æµ‹ç³»ç»Ÿ V1.0

## ğŸŒ é¡¹ç›®ä»‹ç»
æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºPyraformeræ·±åº¦å­¦ä¹ æ¨¡å‹çš„å¤ªé˜³èƒ½è¾ç…§åº¦é¢„æµ‹ç³»ç»Ÿã€‚ç³»ç»Ÿèƒ½å¤ŸåŸºäºå†å²æ°”è±¡æ•°æ®å’Œè¾ç…§åº¦æ•°æ®ï¼Œé¢„æµ‹æœªæ¥3å°æ—¶çš„å¤ªé˜³èƒ½è¾ç…§åº¦ï¼Œå¹¶æ”¯æŒ24å°æ—¶æ»šåŠ¨é¢„æµ‹ã€‚è¯¥ç³»ç»Ÿç‰¹åˆ«é€‚ç”¨äºå¤ªé˜³èƒ½å‘ç”µç«™ã€å…‰ä¼ç”µç«™ç­‰éœ€è¦ç²¾ç¡®è¾ç…§åº¦é¢„æµ‹çš„åœºæ™¯ã€‚

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

| Module                               | Purpose                                     |
|--------------------------------------|---------------------------------------------|
| **`solar_main.py`**                  | ä¸»ç¨‹åºå…¥å£ï¼Œé›†æˆæ¨¡å‹å¾®è°ƒã€è¯„ä¼°å’Œé¢„æµ‹çš„æ ¸å¿ƒæ§åˆ¶å™¨            |
| **`rolling_inference.py`**           | æ»šåŠ¨æ¨ç†æ¨¡å—ï¼Œå®ç°24å°æ—¶æ»šåŠ¨é¢„æµ‹åŠŸèƒ½                  |
| **`fine_turning/solar_model.py`**   | å¤ªé˜³èƒ½é¢„æµ‹æ¨¡å‹å¾®è°ƒç±»ï¼Œè´Ÿè´£æ¨¡å‹è®­ç»ƒå’Œé¢„æµ‹                |
| **`data_processing/get_data.py`**   | æ•°æ®è·å–æ¨¡å—ï¼Œä»InfluxDBå’ŒMySQLæ•°æ®åº“è·å–æ°”è±¡æ•°æ®      |
| **`data_processing/data_imputation.py`** | æ•°æ®é¢„å¤„ç†æ¨¡å—ï¼Œå¤„ç†ç¼ºå¤±å€¼å’Œæ•°æ®æ¸…æ´—                |

---

## âš¡ å¿«é€Ÿå¼€å§‹

1. **ç¯å¢ƒè¦æ±‚**

- Python 3.7æˆ–æ›´é«˜ç‰ˆæœ¬
- CUDAæ”¯æŒçš„GPUï¼ˆæ¨èï¼Œç”¨äºæ¨¡å‹è®­ç»ƒï¼‰
- 8GBä»¥ä¸Šå†…å­˜

2. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone <your-repo-url>
   cd solar_pre_trained
   python -m venv venv
   source venv/bin/activate      # Windowsâ€‘PowerShell: venv\Scripts\Activate.ps1
   ```

3. **å®‰è£…ä¾èµ–**

   ```bash
   pip install -r requirements.txt
   ```

4. **é…ç½®æ•°æ®åº“è¿æ¥**

   ä¿®æ”¹ `config/config.json` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®ï¼š

   ```json
   {
     "Mysql": {
       "host": "your-mysql-host",
       "port": 8806,
       "user": "your-username",
       "password": "your-password",
       "database": "your-database"
     },
     "Influx_config": {
       "host": "your-influxdb-host",
       "port": 8186,
       "user": "admin",
       "password": "your-password",
       "database": "your-database"
     }
   }
   ```

5. **å‡†å¤‡æ•°æ®**

   ç¡®ä¿ä»¥ä¸‹æ•°æ®æ–‡ä»¶å­˜åœ¨ï¼š
   - `data/pre_train_data_57_914.csv` - é¢„è®­ç»ƒæ•°æ®
   - `data/test_data_915_918.csv` - æµ‹è¯•æ•°æ®

6. **å¯åŠ¨ç¨‹åº**

   ```bash
   # æ¨¡å‹å¾®è°ƒ
   python solar_main.py

   # æ»šåŠ¨é¢„æµ‹
   python rolling_inference.py
   ```

---

## ğŸ“ é¡¹ç›®ç»“æ„

``` 
solar_pre_trained/
â”œâ”€â”€ solar_main.py                    # ä¸»ç¨‹åºå…¥å£ï¼Œè´Ÿè´£æ¨¡å‹å¾®è°ƒå’Œè¯„ä¼°
â”œâ”€â”€ rolling_inference.py            # æ»šåŠ¨æ¨ç†æ¨¡å—ï¼Œå®ç°24å°æ—¶æ»šåŠ¨é¢„æµ‹
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.json                 # æ•°æ®åº“é…ç½®æ–‡ä»¶
â”œâ”€â”€ data_processing/                # æ•°æ®å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ get_data.py                # æ•°æ®è·å–æ¨¡å—ï¼ˆInfluxDB/MySQLï¼‰
â”‚   â””â”€â”€ data_imputation.py         # æ•°æ®é¢„å¤„ç†å’Œç¼ºå¤±å€¼å¡«å……
â”œâ”€â”€ fine_turning/                   # æ¨¡å‹å¾®è°ƒæ¨¡å—
â”‚   â”œâ”€â”€ solar_model.py             # å¤ªé˜³èƒ½é¢„æµ‹æ¨¡å‹ç±»
â”‚   â”œâ”€â”€ solar_predict.py           # é¢„æµ‹åŠŸèƒ½æ¨¡å—
â”‚   â””â”€â”€ solar_prediction.py        # é¢„æµ‹ç»“æœå¤„ç†
â”œâ”€â”€ models/                         # æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ Pyraformer.py              # Pyraformeræ¨¡å‹æ¶æ„
â”œâ”€â”€ layers/                         # æ¨¡å‹å±‚å®šä¹‰
â”‚   â”œâ”€â”€ Conv_Blocks.py             # å·ç§¯å—
â”‚   â”œâ”€â”€ Embed.py                   # åµŒå…¥å±‚
â”‚   â”œâ”€â”€ Pyraformer_EncDec.py       # ç¼–ç å™¨-è§£ç å™¨
â”‚   â””â”€â”€ SelfAttention_Family.py    # è‡ªæ³¨æ„åŠ›æœºåˆ¶
â”œâ”€â”€ utils/                          # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ masking.py                 # æ©ç å¤„ç†
â”‚   â”œâ”€â”€ metrics.py                 # è¯„ä¼°æŒ‡æ ‡
â”‚   â”œâ”€â”€ print_args.py              # å‚æ•°æ‰“å°
â”‚   â””â”€â”€ timefeatures.py            # æ—¶é—´ç‰¹å¾æå–
â”œâ”€â”€ model_pth/                      # æ¨¡å‹æƒé‡æ–‡ä»¶
â”‚   â”œâ”€â”€ solar_24h_3h_checkpoint.pth # é¢„è®­ç»ƒæ¨¡å‹
â”‚   â”œâ”€â”€ finetuned_pyraformer_*.pth  # å¾®è°ƒåçš„æ¨¡å‹
â”‚   â””â”€â”€ scaler_solar_24h_3h.pkl    # æ•°æ®æ ‡å‡†åŒ–å™¨
â”œâ”€â”€ data/                          # æ•°æ®ç›®å½•
â”œâ”€â”€ requirements.txt               # Pythonä¾èµ–åº“
â””â”€â”€ README.md                      # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### æ•°æ®åº“é…ç½® (`config/config.json`)

æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹ä»¥ä¸‹é…ç½®å‚æ•°:

```json
{
  "Mysql": {
    "host": "æ•°æ®åº“ä¸»æœºåœ°å€",
    "port": 8806,
    "user": "æ•°æ®åº“ç”¨æˆ·å",
    "password": "æ•°æ®åº“å¯†ç ",
    "database": "æ•°æ®åº“åç§°"
  },
  "Influx_config": {
    "host": "InfluxDBä¸»æœºåœ°å€",
    "port": 8186,
    "user": "InfluxDBç”¨æˆ·å",
    "password": "InfluxDBå¯†ç ",
    "database": "InfluxDBæ•°æ®åº“å"
  }
}
```

- `Mysql`: MySQLæ•°æ®åº“é…ç½®ï¼Œç”¨äºå­˜å‚¨å†å²æ°”è±¡æ•°æ®
- `Influx_config`: InfluxDBæ—¶åºæ•°æ®åº“é…ç½®ï¼Œç”¨äºå­˜å‚¨å®æ—¶æ°”è±¡æ•°æ®

---

## ğŸ”§ è¾“å…¥æ•°æ®æ ¼å¼

### æ•°æ®æ–‡ä»¶è¦æ±‚

ç³»ç»Ÿéœ€è¦ä»¥ä¸‹æ ¼å¼çš„CSVæ•°æ®æ–‡ä»¶ï¼š

```csv
datestr,temp,humidity,windspeed,winddir,pressure,precip,conditions,cloudcover,irradiance
2024-01-01 00:00:00,15.2,65.3,3.2,180,1013.2,0.0,Clear,10,0.0
2024-01-01 01:00:00,14.8,67.1,2.8,175,1013.5,0.0,Clear,5,0.0
...
```

### æ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `datestr` | datetime | æ—¶é—´æˆ³ |
| `temp` | float | æ¸©åº¦ (Â°C) |
| `humidity` | float | æ¹¿åº¦ (%) |
| `windspeed` | float | é£é€Ÿ (m/s) |
| `winddir` | float | é£å‘ (åº¦) |
| `pressure` | float | æ°”å‹ (hPa) |
| `precip` | float | é™æ°´é‡ (mm) |
| `conditions` | string | å¤©æ°”æ¡ä»¶ |
| `cloudcover` | float | äº‘é‡è¦†ç›– (%) |
| `irradiance` | float | è¾ç…§åº¦ (W/mÂ²) |

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. æ¨¡å‹å¾®è°ƒ

```python
from fine_turning.solar_model import SolarModel

# åˆ›å»ºæ¨¡å‹å®ä¾‹
solar_model = SolarModel(
    scaler_path='model_pth/scaler_solar_24h_3h.pkl',
    epochs=10,
    lr=1e-5,
    batch_size=32,
    seq_len=24,
    pred_len=3,
    data_dim=9
)

# åŠ è½½æ•°æ®å¹¶è®­ç»ƒ
data, data_stamp, time_stamp = solar_model.load_and_scaler_data('data/pre_train_data_57_914.csv')
model, save_model_path = solar_model.run('model_pth/solar_24h_3h_checkpoint.pth', data, data_stamp)
```

### 2. æ»šåŠ¨é¢„æµ‹

```python
from rolling_inference import RollingInference

# åˆ›å»ºæ»šåŠ¨æ¨ç†å™¨
rolling_inference = RollingInference(
    model_path='model_pth/finetuned_pyraformer_20250919_194331.pth',
    scaler_path='model_pth/scaler_solar_24h_3h.pkl',
    seq_len=24,
    pred_len=3
)

# æ‰§è¡Œ24å°æ—¶æ»šåŠ¨é¢„æµ‹
predictions = rolling_inference.rolling_predict_24h(
    historical_data=historical_data,
    start_time=datetime(2025, 9, 18, 0, 0)
)
```

### 3. æ•°æ®é¢„å¤„ç†

```python
from data_processing.data_imputation import preprocess_solar_data_with_knn

# ä½¿ç”¨KNNæ–¹æ³•å¤„ç†ç¼ºå¤±å€¼
preprocess_solar_data_with_knn(
    input_file='data/raw_data.csv',
    output_file='data/processed_data.csv',
    target_column='irradiance',
    k=5
)
```

---

## ğŸ“Š æ¨¡å‹æ€§èƒ½

### è¯„ä¼°æŒ‡æ ‡

ç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹æŒ‡æ ‡è¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼š

- **MAE (Mean Absolute Error)**: å¹³å‡ç»å¯¹è¯¯å·®
- **MSE (Mean Squared Error)**: å‡æ–¹è¯¯å·®  
- **RMSE (Root Mean Squared Error)**: å‡æ–¹æ ¹è¯¯å·®
- **RÂ² (R-squared)**: å†³å®šç³»æ•°

### å…¸å‹æ€§èƒ½è¡¨ç°

```
=== è¯„ä¼°ç»“æœ ===
MAE: 45.234567
MSE: 3245.123456
RMSE: 56.789012
R2: 0.876543
```

---

## ğŸ› ï¸ ä¾èµ–åŒ…

ä¸»è¦ä¾èµ–åŒ…æ‹¬ï¼š

```text
torch==1.7.1
numpy==1.23.5
pandas==1.5.3
scikit-learn==1.2.2
matplotlib==3.7.0
einops==0.8.0
local-attention==1.9.14
reformer-pytorch==1.4.4
sktime==0.16.1
```

å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. æ•°æ®è·å–
- ä»InfluxDBè·å–å®æ—¶æ°”è±¡æ•°æ®
- ä»MySQLè·å–å†å²æ°”è±¡æ•°æ®
- æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†

### 2. æ•°æ®é¢„å¤„ç†
- å¤„ç†ç¼ºå¤±å€¼ï¼ˆKNNå¡«å……ï¼‰
- æ•°æ®æ ‡å‡†åŒ–
- æ—¶é—´ç‰¹å¾æå–

### 3. æ¨¡å‹è®­ç»ƒ
- åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
- å¾®è°ƒæ¨¡å‹å‚æ•°
- ä¿å­˜å¾®è°ƒåçš„æ¨¡å‹

### 4. é¢„æµ‹æ¨ç†
- 24å°æ—¶æ»šåŠ¨é¢„æµ‹
- 3å°æ—¶çª—å£é¢„æµ‹
- ç»“æœå¯è§†åŒ–å’Œä¿å­˜

---

## ğŸ“ˆ é¢„æµ‹ç»“æœ

### è¾“å‡ºæ ¼å¼

é¢„æµ‹ç»“æœåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```csv
time,predicted_irradiance,window,hour_in_window
2025-09-18 01:00:00,125.45,1,1
2025-09-18 02:00:00,234.67,1,2
2025-09-18 03:00:00,189.23,1,3
...
```

### å¯è§†åŒ–

ç³»ç»Ÿæä¾›é¢„æµ‹ç»“æœçš„å¯è§†åŒ–åŠŸèƒ½ï¼š
- 24å°æ—¶è¾ç…§åº¦é¢„æµ‹æ›²çº¿
- å®é™…å€¼vsé¢„æµ‹å€¼å¯¹æ¯”
- é¢„æµ‹è¯¯å·®åˆ†æ

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è´¨é‡**: ç¡®ä¿è¾“å…¥æ•°æ®çš„è´¨é‡å’Œå®Œæ•´æ€§ï¼Œç¼ºå¤±å€¼ä¼šå½±å“é¢„æµ‹ç²¾åº¦
2. **æ¨¡å‹æ›´æ–°**: å»ºè®®å®šæœŸä½¿ç”¨æœ€æ–°æ•°æ®é‡æ–°è®­ç»ƒæ¨¡å‹
3. **ç¡¬ä»¶è¦æ±‚**: è®­ç»ƒè¿‡ç¨‹éœ€è¦GPUæ”¯æŒï¼Œæ¨ç†å¯ä»¥åœ¨CPUä¸Šè¿è¡Œ
4. **æ•°æ®æ ¼å¼**: ç¡®ä¿è¾“å…¥æ•°æ®æ ¼å¼ä¸è®­ç»ƒæ—¶ä¸€è‡´

---

## ğŸ“§ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤Issueã€‚

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚
